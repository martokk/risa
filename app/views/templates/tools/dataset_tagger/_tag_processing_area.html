{# HTMX Tag Processing Area Partial - Updated for Phase 4 #}

{# Display current step information if available #}
{% if initial_step_name or initial_step_description %}
    <h5>
        Step: {{ initial_step_name | default('N/A') }}
        {% if initial_step_description %}
            <small class="text-muted">- {{ initial_step_description }}</small>
        {% endif %}
    </h5>
    <hr>
{% endif %}

{# Display Notification Message #}
{% if notification_message %}
    <div class="alert alert-{{ notification_type | default('info') }} alert-dismissible fade show" role="alert">
        {{ notification_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}

{# Form to wrap inputs and buttons for HTMX submission #}
{# Temporarily hardcoding URL for debugging #}
<form hx-post="{{ url_for('post_dataset_tagger_process_tag') }}" hx-target="#tag-processor" hx-swap="innerHTML">

    {# Display the initial item (tag or manual question prompt) #}
    <div class="mb-3">
        {% if initial_item_type == "manual_question" %}
            <label for="manual_tag_input" class="form-label"><strong>Question:</strong> {{ initial_display_item }}</label>
            <input type="text" class="form-control" id="manual_tag_input" name="manual_tag_input" placeholder="Enter comma-separated tags here...">
            {# Removed readonly/disabled, added required #}
        {% elif initial_item_type == "tag" %}
            <p><strong>Current Tag:</strong> {{ initial_display_item }}</p>
        {% elif initial_item_type == "complete" %}
            <div class="alert alert-success">{{ initial_display_item }}</div>
        {% elif initial_item_type == "info" %}
            <div class="alert alert-info">{{ initial_display_item }}</div>
        {% else %}
            <p>{{ initial_display_item | default("Loading...") }}</p>
        {% endif %}
    </div>

    {# Hidden fields for TaggingWorkflowState - Values from initial_state context #}
    {# These are now inside the form #}
    <input type="hidden" name="character_id" value="{{ initial_state.character_id }}">
    <input type="hidden" name="folder_path" value="{{ initial_state.folder_path }}">
    <input type="hidden" name="current_step_index" value="{{ initial_state.current_step_index }}">
    <input type="hidden" name="current_input_type_index_in_step" value="{{ initial_state.current_input_type_index_in_step }}">
    <input type="hidden" name="current_item_index_within_input_type" value="{{ initial_state.current_item_index_within_input_type }}">
    <input type="hidden" name="pending_tags_from_last_manual_input" value="{{ initial_state.pending_tags_from_last_manual_input | join(',') }}">
    <input type="hidden" name="active_manual_input_key" value="{{ initial_state.active_manual_input_key | default('') }}">
    <input type="hidden" name="selected_images_input" id="selectedImagesInput" value=""> {# For JS image selection (Phase 5) #}

    {# Action buttons - now part of the form #}
    {# Only enable buttons if not in 'complete' state #}
    {% if initial_item_type != 'complete' %}
        <div class="mt-3">
            {% if initial_item_type == "manual_question" %}
                <button type="submit" name="action" value="submit_manual_input" class="btn btn-success me-2">Submit Tags</button>
                <button type="submit" name="action" value="skip_tag" class="btn btn-secondary me-2">Skip Question</button> 
                {# Changed skip_tag value if needed, or handle action="skip_tag" for questions in Python #}
            {% elif initial_item_type == "tag" %}
                <button type="submit" name="action" value="add_tag" class="btn btn-primary me-2">Add Tag to Selected</button> {# Enabled #}
                <button type="submit" name="action" value="skip_tag" class="btn btn-secondary me-2">Skip Tag</button>
            {% endif %}
            <button type="button" class="btn btn-info" disabled>Select All Images</button> {# JS controlled, Phase 5 #}
        </div>
    {% endif %}

</form>

{% if initial_item_type != 'complete' %}
<div class="mt-2 form-text text-muted">
    Phase 4: Manual input and "Add Tag" are now enabled. Image selection JS pending (Phase 5).
</div>
{% endif %}
