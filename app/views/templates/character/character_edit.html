{% extends "base/base.html" %}

{% block title %}Edit: {{ character.name }}{% endblock %}
{% block content_header %}Editr: {{ character.name }} ({{ character.id }}){% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card card-warning">
        <div class="card-header">
            <h3 class="card-title">Update Character: {{ character.name }}</h3>
        </div>
        <form id="editCharacterForm">
            <input type="hidden" name="id" value="{{ character.id }}"> <!-- Keep original ID for the PUT request path -->
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="characterIdEdit">ID</label>
                            <input type="text" class="form-control" id="characterIdEdit" name="id_display" value="{{ character.id }}">
                        </div>
                        <div class="form-group">
                            <label for="personName">Person Name</label>
                            <input type="text" class="form-control" id="personName" name="person_name" value="{{ character.person_name if character.person_name is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="characterName1">Character Name 1</label>
                            <input type="text" class="form-control" id="characterName1" name="character_name1" value="{{ character.character_name1 if character.character_name1 is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="characterName2">Character Name 2</label>
                            <input type="text" class="form-control" id="characterName2" name="character_name2" value="{{ character.character_name2 if character.character_name2 is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="characterName3">Character Name 3</label>
                            <input type="text" class="form-control" id="characterName3" name="character_name3" value="{{ character.character_name3 if character.character_name3 is not none }}">
                        </div>


                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="characterIsKnown" name="is_known" {% if character.is_known %}checked{% endif %}>
                                <label class="form-check-label" for="characterIsKnown">Is Known</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="characterAgeGroup">Age Group</label>
                            <input type="text" class="form-control" id="characterAgeGroup" name="age_group" value="{{ character.age_group if character.age_group is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">child</small></li>
                                <li><small class="form-text text-muted">teenager</small></li>
                                <li><small class="form-text text-muted">young adult</small></li>
                                <li><small class="form-text text-muted">adult</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="characterRace">Race</label>
                            <input type="text" class="form-control" id="characterRace" name="race" value="{{ character.race if character.race is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="characterSkinColor">Skin Color</label>
                            <input type="text" class="form-control" id="characterSkinColor" name="skin_color" value="{{ character.skin_color if character.skin_color is not none }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Head Attributes</h5>
                        <div class="form-group">
                            <label for="hairColor">Hair Color</label>
                            <input type="text" class="form-control" id="hairColor" name="hair_color" value="{{ character.hair_color if character.hair_color is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="hairStyle">Hair Style</label>
                            <input type="text" class="form-control" id="hairStyle" name="hair_style" value="{{ character.hair_style if character.hair_style is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="hairLength">Hair Length</label>
                            <input type="text" class="form-control" id="hairLength" name="hair_length" value="{{ character.hair_length if character.hair_length is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="faceType">Face Type</label>
                            <input type="text" class="form-control" id="faceType" name="face_type" value="{{ character.face_type if character.face_type is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="eyeColor">Eye Color</label>
                            <input type="text" class="form-control" id="eyeColor" name="eye_color" value="{{ character.eye_color if character.eye_color is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="makeupType">Makeup Type</label>
                            <input type="text" class="form-control" id="makeupType" name="makeup_type" value="{{ character.makeup_type if character.makeup_type is not none }}">
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Body Attributes</h5>
                        <div class="form-group">
                            <label for="bodyType">Body Type</label>
                            <input type="text" class="form-control" id="bodyType" name="body_type" value="{{ character.body_type if character.body_type is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">athletic body</small></li>
                                <li><small class="form-text text-muted">curvy body</small></li>
                                <li><small class="form-text text-muted">thick body</small></li>
                                <li><small class="form-text text-muted">petite body, thin, skinny, athletic, short</small></li>
                                <li><small class="form-text text-muted">tall, skinny</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="breastsType">Breasts Type</label>
                            <input type="text" class="form-control" id="breastsType" name="breasts_type" value="{{ character.breasts_type if character.breasts_type is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">natural breasts</small></li>
                                <li><small class="form-text text-muted">perky breasts, pointy breasts</small></li>
                                <li><small class="form-text text-muted">teardrop breasts</small></li>
                                <li><small class="form-text text-muted">teardrop breasts, perky breasts</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="breastsSize">Breasts Size</label>
                            <input type="text" class="form-control" id="breastsSize" name="breasts_size" value="{{ character.breasts_size if character.breasts_size is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">flat chest</small></li>
                                <li><small class="form-text text-muted">small breasts</small></li>
                                <li><small class="form-text text-muted">medium breasts</small></li>
                                <li><small class="form-text text-muted">large breasts</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="nipplesType">Nipples Type</label>
                            <input type="text" class="form-control" id="nipplesType" name="nipples_type" value="{{ character.nipples_type if character.nipples_type is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">dark nipples</small></li>
                                <li><small class="form-text text-muted">light nipples</small></li>
                                <li><small class="form-text text-muted">pink nipples</small></li>
                                <li><small class="form-text text-muted">small nipples</small></li>
                                <li><small class="form-text text-muted">large nipples</small></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Other Physical Attributes</h5>
                        <div class="form-group">
                            <label for="handsType">Hands Type</label>
                            <input type="text" class="form-control" id="handsType" name="hands_type" value="{{ character.hands_type if character.hands_type is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="hipsType">Hips Type</label>
                            <input type="text" class="form-control" id="hipsType" name="hips_type" value="{{ character.hips_type if character.hips_type is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">small hips, thin hips</small></li>
                                <li><small class="form-text text-muted">thick thighs, thin waist</small></li>
                                <li><small class="form-text text-muted">wide hips, wide thighs</small></li>
                                <li><small class="form-text text-muted">thin hips</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="assType">Ass Type</label>
                            <input type="text" class="form-control" id="assType" name="ass_type" value="{{ character.ass_type if character.ass_type is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">perfect ass, thick ass, bubble butt</small></li>
                                <li><small class="form-text text-muted">perfect ass, tight ass, bubble butt, small ass</small></li>
                                <li><small class="form-text text-muted">thick ass, pawg, big ass</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="pussyType">Pussy Type</label>
                            <input type="text" class="form-control" id="pussyType" name="pussy_type" value="{{ character.pussy_type if character.pussy_type is not none }}">
                            <ul>
                                <li><small class="form-text text-muted">perfect pussy</small></li>
                                <li><small class="form-text text-muted">perfect pussy, labia</small></li>
                                <li><small class="form-text text-muted">innie pussy, perfect pussy, tight pussy, puffy pussy, mons pubis</small></li>
                                <li><small class="form-text text-muted">pussy, large labia, clit, clitoris</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="legsType">Legs Type</label>
                            <input type="text" class="form-control" id="legsType" name="legs_type" value="{{ character.legs_type if character.legs_type is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="feetType">Feet Type</label>
                            <input type="text" class="form-control" id="feetType" name="feet_type" value="{{ character.feet_type if character.feet_type is not none }}">
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h5>Clothing Attributes</h5>
                        <div class="form-group">
                            <label for="clothingHead">Clothing - Head</label>
                            <input type="text" class="form-control" id="clothingHead" name="clothing_head" value="{{ character.clothing_head if character.clothing_head is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="clothingUpperBody">Clothing - Upper Body</label>
                            <input type="text" class="form-control" id="clothingUpperBody" name="clothing_upper_body" value="{{ character.clothing_upper_body if character.clothing_upper_body is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="clothingLowerBody">Clothing - Lower Body</label>
                            <input type="text" class="form-control" id="clothingLowerBody" name="clothing_lower_body" value="{{ character.clothing_lower_body if character.clothing_lower_body is not none }}">
                        </div>
                        <div class="form-group">
                            <label for="clothingFeet">Clothing - Feet</label>
                            <input type="text" class="form-control" id="clothingFeet" name="clothing_feet" value="{{ character.clothing_feet if character.clothing_feet is not none }}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-warning">Update</button>
                <a href="{{ url_for('list_characters_page') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block js_scripts %}
<script type="module">
    import { initializeApi, apiCrud, uiHelpers } from '/static/js/api_utils.js';

    {% if tokens and tokens.access_token and tokens.refresh_token %}
    initializeApi({
        access_token: "{{ tokens.access_token }}",
        refresh_token: "{{ tokens.refresh_token }}"
    });
    {% else %}
    console.warn('API tokens not found in template context. API calls might fail if authentication is required.');
    initializeApi({});
    {% endif %}

    const form = document.getElementById('editCharacterForm');
    if (form) {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            try {
                const formData = uiHelpers.getFormData('editCharacterForm');
                const characterId = formData.id; // This is from the hidden input, the original ID.
                
                // Create a payload for update, excluding the id_display field and the original id from the payload itself.
                const updatePayload = {};
                for (const key in formData) {
                    if (key !== 'id' && key !== 'id_display') { // Exclude original id and display id from payload
                        if (formData[key] !== "" && formData[key] !== null) { // Send non-empty values
                            updatePayload[key] = formData[key];
                        } else {
                             updatePayload[key] = null; // Explicitly send null for fields emptied by user
                        }
                    }
                }
                // The CharacterUpdate model on backend expects all fields from CharacterBase.
                // Ensure all fields are present, even if null.
                const allCharacterBaseFields = ["name", "race", "skin_color", "hair_color", "hair_style", "hair_length", "face_type", "eye_color", "makeup_type", "body_type", "breasts_type", "breasts_size", "nipples_type", "hands_type", "hips_type", "ass_type", "pussy_type", "legs_type", "feet_type", "clothing_head", "clothing_upper_body", "clothing_lower_body", "clothing_feet"];
                allCharacterBaseFields.forEach(field => {
                    if (!(field in updatePayload)) {
                        updatePayload[field] = null; // Ensure field is present if not set by form
                    }
                });
                updatePayload.name = formData.name; // Name is required, ensure it's in payload


                await apiCrud.update('characters', characterId, updatePayload);
                uiHelpers.showToast('Character updated successfully!', 'success');
                setTimeout(() => {
                    window.location.href = "{{ url_for('list_characters_page') }}";
                }, 1500);
            } catch (error) {
                console.error('Failed to update Character:', error);
                uiHelpers.showError(error.responseJSON?.detail || error.message || 'Failed to update Character. Please check console for details.');
            }
        });
    }
</script>
{% endblock %} 
