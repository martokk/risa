{% extends "base/base.html" %}

{% block title %}Create Character{% endblock %}
{% block content_header %}Create New Character{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title">Character Details</h3>
        </div>
        <form id="createCharacterForm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="personName">Person Name</label>
                            <input type="text" class="form-control" id="personName" name="person_name">
                            <small id="personNamePreview" class="form-text text-muted"></small>
                        </div>

                        <div class="form-group">
                            <label for="characterName1">Character Name 1</label>
                            <input type="text" class="form-control" id="characterName1" name="character_name1">
                        </div>
                        <div class="form-group">
                            <label for="characterName2">Character Name 2</label>
                            <input type="text" class="form-control" id="characterName2" name="character_name2">
                        </div>
                        <div class="form-group">
                            <label for="characterName3">Character Name 3</label>
                            <input type="text" class="form-control" id="characterName3" name="character_name3">
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="characterIsKnown" name="is_known">
                                <label class="form-check-label" for="characterIsKnown">Is Known</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="characterAgeGroup">Age Group</label>
                            <input type="text" class="form-control" id="characterAgeGroup" name="age_group">
                            <ul>
                                <li><small class="form-text text-muted">child</small></li>
                                <li><small class="form-text text-muted">teenager</small></li>
                                <li><small class="form-text text-muted">young adult</small></li>
                                <li><small class="form-text text-muted">adult</small></li>
                                <li><small class="form-text text-muted">middle-aged</small></li>
                                <li><small class="form-text text-muted">elderly</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="characterRace">Race</label>
                            <input type="text" class="form-control" id="characterRace" name="race">
                        </div>
                        <div class="form-group">
                            <label for="characterSkinColor">Skin Color</label>
                            <input type="text" class="form-control" id="characterSkinColor" name="skin_color">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Head Attributes</h5>
                        <div class="form-group">
                            <label for="hairColor">Hair Color</label>
                            <input type="text" class="form-control" id="hairColor" name="hair_color">
                        </div>
                        <div class="form-group">
                            <label for="hairStyle">Hair Style</label>
                            <input type="text" class="form-control" id="hairStyle" name="hair_style">
                        </div>
                        <div class="form-group">
                            <label for="hairLength">Hair Length</label>
                            <input type="text" class="form-control" id="hairLength" name="hair_length">
                        </div>
                        <div class="form-group">
                            <label for="faceType">Face Type</label>
                            <input type="text" class="form-control" id="faceType" name="face_type">
                        </div>
                        <div class="form-group">
                            <label for="eyeColor">Eye Color</label>
                            <input type="text" class="form-control" id="eyeColor" name="eye_color">
                        </div>
                        <div class="form-group">
                            <label for="makeupType">Makeup Type</label>
                            <input type="text" class="form-control" id="makeupType" name="makeup_type">
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Body Attributes</h5>
                        <div class="form-group">
                            <label for="bodyType">Body Type</label>
                            <input type="text" class="form-control" id="bodyType" name="body_type">
                            <ul>
                                <li><small class="form-text text-muted">athletic body</small></li>
                                <li><small class="form-text text-muted">curvy body</small></li>
                                <li><small class="form-text text-muted">thick body</small></li>
                                <li><small class="form-text text-muted">petite body, thin, skinny, athletic, short</small></li>
                                <li><small class="form-text text-muted">tall, skinny</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="breastsType">Breasts Type</label>
                            <input type="text" class="form-control" id="breastsType" name="breasts_type">
                            <ul>
                                <li><small class="form-text text-muted">natural breasts</small></li>
                                <li><small class="form-text text-muted">perky breasts, pointy breasts</small></li>
                                <li><small class="form-text text-muted">teardrop breasts</small></li>
                                <li><small class="form-text text-muted">teardrop breasts, perky breasts</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="breastsSize">Breasts Size</label>
                            <input type="text" class="form-control" id="breastsSize" name="breasts_size">
                            <ul>
                                <li><small class="form-text text-muted">flat chest</small></li>
                                <li><small class="form-text text-muted">small breasts</small></li>
                                <li><small class="form-text text-muted">medium breasts</small></li>
                                <li><small class="form-text text-muted">large breasts</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="nipplesType">Nipples Type</label>
                            <input type="text" class="form-control" id="nipplesType" name="nipples_type">
                            <ul>
                                <li><small class="form-text text-muted">dark nipples</small></li>
                                <li><small class="form-text text-muted">light nipples</small></li>
                                <li><small class="form-text text-muted">pink nipples</small></li>
                                <li><small class="form-text text-muted">small nipples</small></li>
                                <li><small class="form-text text-muted">large nipples</small></li>
                                <li><small class="form-text text-muted">puffy nipples</small></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Other Physical Attributes</h5>
                        <div class="form-group">
                            <label for="handsType">Hands Type</label>
                            <input type="text" class="form-control" id="handsType" name="hands_type">
                        </div>
                        <div class="form-group">
                            <label for="hipsType">Hips Type</label>
                            <input type="text" class="form-control" id="hipsType" name="hips_type">
                            <ul>
                                <li><small class="form-text text-muted">small hips, thin hips</small></li>
                                <li><small class="form-text text-muted">thick thighs, thin waist</small></li>
                                <li><small class="form-text text-muted">wide hips, thick thighs, thin waist</small></li>
                                <li><small class="form-text text-muted">wide hips, wide thighs</small></li>
                                <li><small class="form-text text-muted">thin hips</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="assType">Ass Type</label>
                            <input type="text" class="form-control" id="assType" name="ass_type">
                            <ul>
                                <li><small class="form-text text-muted">perfect ass, thick ass, bubble butt</small></li>
                                <li><small class="form-text text-muted">perfect ass, tight ass, bubble butt, small ass</small></li>
                                <li><small class="form-text text-muted">thick ass, pawg, big ass</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="pussyType">Pussy Type</label>
                            <input type="text" class="form-control" id="pussyType" name="pussy_type">
                            <ul>
                                <li><small class="form-text text-muted">perfect pussy</small></li>
                                <li><small class="form-text text-muted">perfect pussy, labia</small></li>
                                <li><small class="form-text text-muted">innie pussy, perfect pussy, tight pussy, puffy pussy, mons pubis</small></li>
                                <li><small class="form-text text-muted">pussy, large labia, clit, clitoris</small></li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="legsType">Legs Type</label>
                            <input type="text" class="form-control" id="legsType" name="legs_type">
                        </div>
                        <div class="form-group">
                            <label for="feetType">Feet Type</label>
                            <input type="text" class="form-control" id="feetType" name="feet_type">
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h5>Clothing Attributes</h5>
                        <div class="form-group">
                            <label for="clothingHead">Clothing - Head</label>
                            <input type="text" class="form-control" id="clothingHead" name="clothing_head">
                        </div>
                        <div class="form-group">
                            <label for="clothingUpperBody">Clothing - Upper Body</label>
                            <input type="text" class="form-control" id="clothingUpperBody" name="clothing_upper_body">
                        </div>
                        <div class="form-group">
                            <label for="clothingLowerBody">Clothing - Lower Body</label>
                            <input type="text" class="form-control" id="clothingLowerBody" name="clothing_lower_body">
                        </div>
                        <div class="form-group">
                            <label for="clothingFeet">Clothing - Feet</label>
                            <input type="text" class="form-control" id="clothingFeet" name="clothing_feet">
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-primary">Submit</button>
                <a href="{{ url_for('list_characters_page') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block js_scripts %}
<script type="module">
    import { initializeApi, apiCrud, uiHelpers } from '/static/js/api_utils.js';

    {% if tokens and tokens.access_token and tokens.refresh_token %}
    initializeApi({
        access_token: "{{ tokens.access_token }}",
        refresh_token: "{{ tokens.refresh_token }}"
    });
    {% else %}
    console.warn('API tokens not found in template context. API calls might fail if authentication is required.');
    initializeApi({});
    {% endif %}

    const form = document.getElementById('createCharacterForm');
    if (form) {
        // Function to convert string to Title Case and handle special characters
        function formatName(name) {
            // Replace underscores and dashes with spaces
            name = name.replace(/[_-]+/g, ' ');
            
            // Convert to Title Case (handling multiple words)
            return name.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ')
                .trim();
        }

        // Add name input event listener to show generated ID and formatted name
        const personNameInput = document.getElementById('personName');
        const personNamePreview = document.getElementById('personNamePreview');
        
        personNameInput.addEventListener('input', function(e) {
            const rawValue = e.target.value;
            const formattedName = formatName(rawValue);
            const generatedId = rawValue.toLowerCase().replace(/\s+/g, '_');
            
            // Show the formatted name if it's different from the input
            if (formattedName !== rawValue) {
                personNamePreview.textContent = `Will be saved as: ${formattedName}`;
            } else {
                personNamePreview.textContent = '';
            }
            
            console.log('Generated ID:', generatedId);
        });

        // Auto-format the name when focus is lost
        personNameInput.addEventListener('blur', function(e) {
            const formattedName = formatName(e.target.value);
            e.target.value = formattedName;
            personNamePreview.textContent = ''; // Clear preview since we've applied the formatting
        });

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Get form data outside try block so it's accessible in catch
            const formData = uiHelpers.getFormData('createCharacterForm');
            const processedFormData = {};
            
            try {
                // Format the name before generating ID
                formData.person_name = formData.person_name ? formatName(formData.person_name) : formData.person_name;
                formData.character_name1 = formData.character_name1 ? formatName(formData.character_name1) : formData.character_name1;

                const id_name = formData.person_name || formData.character_name1;

                // Generate ID from formatted name
                formData.id = id_name.toLowerCase().replace(/\s+/g, '_');
                
                // Filter out empty string values to send them as null or not at all
                for (const key in formData) {
                    if (formData[key] !== "") {
                        processedFormData[key] = formData[key];
                    }
                }

                const response = await apiCrud.create('characters', processedFormData);
                uiHelpers.showToast('Character created successfully!', 'success');
                setTimeout(() => {
                    uiHelpers.navigateTo(`/characters`);
                }, 1000);
            } catch (error) {
                console.error('Failed to create Character:', error);
                let errorMessage = error.message || 'Failed to create Character. Please check console for details.';
                
                // Parse common error messages
                if (errorMessage.includes('UNIQUE constraint failed')) {
                    errorMessage = `A character with the ID "${processedFormData.id}" already exists. Please use a different name.`;
                }
                
                uiHelpers.showToast(errorMessage, 'error');
            }
        });
    }
</script>
{% endblock %} 
