{% extends "base/base.html" %}

{% block title %}Grant Cycle: {{ grant_cycle.name }}{% endblock %}

{% block content %}
<div class="container py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">

        <!-- Title -->
        <div>
            <p class="text-muted mb-2">
                <a href="/organizations/{{ grant_cycle.grant_program.organization.id }}">
                    {{ grant_cycle.grant_program.organization.name }} 
                </a>
                :
                <a href="/grant-programs/{{ grant_cycle.grant_program.id }}">
                    {{ grant_cycle.grant_program.name }}
                </a>
            </p>
            <h4>Grant Cycle: {{ grant_cycle.name }}</h4>
        </div>

        <!-- Actions -->
        <div class="btn-group" role="group">
            <a href="/grant-cycles/{{ grant_cycle.id }}/edit" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit
            </a>
            <button type="button" class="btn btn-danger" onclick="deleteGrantCycle('{{ grant_cycle.id }}')">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>

    </div>

    <!-- Body -->
    <div class="row">
        <div class="col-md-7">

            <!-- Grant CycleDetails Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Grant Cycle Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">

                    <!-- URL Section -->
                    <dt class="col-sm-4">URL</dt>
                    <dd class="col-sm-8">
                        <a href="{{ grant_cycle.grant_program.url }}" target="_blank">
                            {{ grant_cycle.grant_program.url }}
                        </a>
                    </dd>
            
                    <!-- Status Section -->
                    <dt class="col-sm-4">Status</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-{{ grant_cycle.status | status_color }}">
                            {{ grant_cycle.status.value }}
                        </span>
                    </dd>
            
                    </dl>
                </div>
            </div>

            <!-- Grant Program Details Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Grant Cycle Details</h5>
                </div>
                <!-- Body -->
                <div class="card-body">
                
                    <!-- Organization -->
                    <dl class="row">
                        <dt class="col-sm-3">Organization</dt>
                        <dd class="col-sm-9">
                            <a href="/organizations/{{ grant_cycle.grant_program.organization.id }}">
                                {{ grant_cycle.grant_program.organization.name }}
                            </a>
                        </dd>
                    </dl>
                
                    <!-- Frequency -->
                    <dl class="row">
                        <dt class="col-sm-3">Frequency</dt>
                        <dd class="col-sm-9">{{ grant_cycle.grant_program.frequency.value }}</dd>
                    </dl>
                
                    <!-- Status -->
                    <dl class="row">
                        <dt class="col-sm-3">Status</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-{{ grant_cycle.grant_program.status | active_status }}">
                                {{ grant_cycle.grant_program.status.value }}
                            </span>
                        </dd>
                    </dl>
                
                    <!-- Description -->
                    <dl class="row">
                        <dt class="col-sm-3">Description</dt>
                        <dd class="col-sm-9">{{ grant_cycle.grant_program.description | nl2br | safe }}</dd>
                    </dl>
                
                    <!-- Website -->
                    {% if grant_cycle.grant_program.url %}
                    <dl class="row">
                        <dt class="col-sm-3">Website</dt>
                        <dd class="col-sm-9">
                            <a href="{{ grant_cycle.grant_program.url }}" target="_blank" rel="noopener noreferrer">
                                {{ grant_cycle.grant_program.url }}
                            </a>
                        </dd>
                    </dl>
                    {% endif %}
                
                    <!-- Funding Range -->
                    <dl class="row">
                        <dt class="col-sm-3">Funding Range</dt>
                        <dd class="col-sm-9">{{ grant_cycle.grant_program.funding_range }}</dd>
                    </dl>
                
                    <!-- Settings -->
                    <dl class="row">
                        <dt class="col-sm-3">Settings</dt>
                        <dd class="col-sm-9">
                            {% if grant_cycle.grant_program.requires_loi %}
                            <span class="badge bg-info">Requires LOI</span>
                            {% endif %}
                        </dd>
                    </dl>
                
                    <!-- Funding Exclusions -->
                    <dl class="row">
                        <dt class="col-sm-3">Funding Exclusions</dt>
                        <dd class="col-sm-9">
                            {% if grant_cycle.grant_program.excludes_operating_expenses %}
                            <span class="badge bg-warning">Operating Expenses</span>
                            {% endif %}
                            {% if grant_cycle.grant_program.excludes_salaries %}
                            <span class="badge bg-warning">Salaries</span>
                            {% endif %}
                            {% if grant_cycle.grant_program.excludes_administrative_overhead %}
                            <span class="badge bg-warning">Administrative Overhead</span>
                            {% endif %}
                            {% if grant_cycle.grant_program.excludes_capital_expenditures %}
                            <span class="badge bg-warning">Capital Expenditures</span>
                            {% endif %}
                            {% if grant_cycle.grant_program.excludes_debt_service %}
                            <span class="badge bg-warning">Debt Service</span>
                            {% endif %}
                            {% if grant_cycle.grant_program.excludes_fundraising_expenses %}
                            <span class="badge bg-warning">Fundraising Expenses</span>
                            {% endif %}
                            {% if not (
                            grant_cycle.grant_program.excludes_operating_expenses or
                            grant_cycle.grant_program.excludes_salaries or
                            grant_cycle.grant_program.excludes_administrative_overhead or
                            grant_cycle.grant_program.excludes_capital_expenditures or
                            grant_cycle.grant_program.excludes_debt_service or
                            grant_cycle.grant_program.excludes_fundraising_expenses
                            ) %}
                            <span class="text-muted">None</span>
                            {% endif %}
                        </dd>
                    </dl>
                
                </div>
            </div>

            <!-- Grant Proposal Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Grant Proposal</h5>
                    {% if grant_cycle.grant_proposal %}
                    <a href="/grant-cycles/{{ grant_cycle.id }}/proposal" class="btn btn-sm btn-primary">
                        <i class="fas fa-edit"></i> Edit Proposal
                    </a>
                    {% else %}
                    <a href="/grant-cycles/{{ grant_cycle.id }}/proposal" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Create Proposal
                    </a>
                    {% endif %}
                </div>
                {% if grant_cycle.grant_proposal %}
                <div class="card-body">
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-4">Consise Name</dt>
                        <dd class="col-sm-8">{{ grant_cycle.grant_proposal.consise_name or 'Not set' }}</dd>
                    </dl>
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-4">Project Name</dt>
                        <dd class="col-sm-8">{{ grant_cycle.grant_proposal.project_name or 'Not set' }}</dd>
                    </dl>
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-4">Summary</dt>
                        <dd class="col-sm-8">{{ grant_cycle.grant_proposal.summary or 'Not set' }}</dd>
                    </dl>
                    <dl class="row py-1">
                        <dt class="col-sm-4">Requested Amount</dt>
                        <dd class="col-sm-8">${{ grant_cycle.grant_proposal.requested_amount | format_currency }}</dd>
                    </dl>
                </div>
                {% else %}
                <div class="card-body text-center text-muted">
                    <p class="mb-0">No proposal created yet</p>
                </div>
                {% endif %}
            </div>

            
        </div>

        <!-- Sidebar -->
        <div class="col-md-5">

            <!-- Timeline Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Timeline</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">

                        <!-- LOI Section -->
                        {% if grant_cycle.loi_open_date_verification.value != "Not Applicable" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="col-5 fw-bold">LOI Open</span>
                            <span class="col-4 text-white me-2">
                                {{ grant_cycle.loi_open_date | format_date or 'Unknown' }}
                            </span>
                            <span class="col-3 badge bg-{{ grant_cycle.loi_open_date_verification | verification_color }}">
                                {{ grant_cycle.loi_open_date_verification.value }}
                            </span>
                        </li>
                        {% endif %}

                        {% if grant_cycle.loi_due_date_verification.value != "Not Applicable" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="col-5 fw-bold">LOI Due</span>
                            <span class="col-4 text-white me-2">
                                {{ grant_cycle.loi_due_date | format_date or 'Unknown' }}
                            </span>
                            <span class="col-3 badge bg-{{ grant_cycle.loi_due_date_verification | verification_color }}">
                                {{ grant_cycle.loi_due_date_verification.value }}
                            </span>
                        </li>
                        {% endif %}

                        {% if grant_cycle.loi_submitted_date %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="col-5 fw-bold">LOI Submitted</span>
                            <span class="col-4 text-white me-2">
                                {{ grant_cycle.loi_submitted_date | format_date or 'Unknown' }}
                            </span>
                            <span class="col-3 badge bg-success">Submitted</span>
                        </li>
                        {% endif %}

                        <!-- Application Section -->
                        {% if grant_cycle.application_open_date_verification.value != "Not Applicable" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="col-5 fw-bold">Application Open</span>
                            <span class="col-4 text-white me-2">
                                {{ grant_cycle.application_open_date | format_date or 'Unknown' }}
                            </span>
                            <span class="col-3 badge bg-{{ grant_cycle.application_open_date_verification | verification_color }}">
                                {{ grant_cycle.application_open_date_verification.value }}
                            </span>
                        </li>
                        {% endif %}

                        {% if grant_cycle.application_due_date_verification.value != "Not Applicable" %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="col-5 fw-bold">Application Due</span>
                            <span class="col-4 text-white me-2">
                                {{ grant_cycle.application_due_date | format_date or 'Unknown' }}
                            </span>
                            <span class="col-3 badge bg-{{ grant_cycle.application_due_date_verification | verification_color }}">
                                {{ grant_cycle.application_due_date_verification.value }}
                            </span>
                        </li>
                        {% endif %}

                        <!-- Decision Section -->
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="col-5 fw-bold">Decision</span>
                            <span class="col-4 text-white me-2">
                                {{ grant_cycle.decision_date | format_date or 'Unknown' }}
                            </span>
                            <span class="col-3 badge bg-{{ grant_cycle.decision_date_verification | verification_color }}">
                                {{ grant_cycle.decision_date_verification.value }}
                            </span>
                        </li>

                        <!-- Payout Section -->
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="col-5 fw-bold">Payout</span>
                            <span class="col-4 text-white me-2">
                                {{ grant_cycle.payout_date | format_date or 'Unknown' }}
                            </span>
                            <span class="col-3 badge bg-{{ grant_cycle.payout_date_verification | verification_color }}">
                                {{ grant_cycle.payout_date_verification.value }}
                            </span>
                        </li>
                        
                    </ul>
                </div>
            </div>


            <!-- Award Details Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Award Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-6 ">Amount Requested</dt>
                        <dd class="col-sm-6 text-end">${{ grant_cycle.amount_requested | format_currency }}</dd>
                    </dl>
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-6">Amount Received</dt>
                        <dd class="col-sm-6 text-end">${{ grant_cycle.amount_awarded_received | format_currency }}</dd>
                    </dl>
                    <dl class="row py-1 border-bottom">    
                        <dt class="col-sm-6">Amount Awaiting</dt>
                        <dd class="col-sm-6 text-end">${{ grant_cycle.amount_awarded_awaiting | format_currency }}</dd>
                    </dl>
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-6">Total Awarded</dt>
                        <dd class="col-sm-6 text-end">${{ grant_cycle.amount_awarded | format_currency }}</dd>
                    </dl>
                    <dl class="row py-1">
                        <dt class="col-sm-6">Percent Funded</dt>
                        <dd class="col-sm-6 text-end">{{ grant_cycle.percent_funded| default('Unknown') }}%</dd>
                    </dl>
                </div>
            </div>

            <!-- Grant Disbursement Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Grant Disbursement</h5>
                </div>
                <div class="card-body">
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-6 ">Total Funding Disbursed</dt>
                        <dd class="col-sm-6 text-end">${{ grant_cycle.total_funding_disbursed | format_currency }}</dd>
                    </dl>
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-6">Total Recipients</dt>
                        <dd class="col-sm-6 text-end">{{ grant_cycle.total_recipients }}</dd>
                    </dl>
                    <dl class="row py-1 border-bottom">
                        <dt class="col-sm-6">Average Award Amount</dt>
                        <dd class="col-sm-6 text-end">${{ grant_cycle.average_award_amount | format_currency }}</dd>
                    </dl>
                </div>
            </div>


        </div>
    </div>
</div>
{% endblock %}

{% block js_scripts %}
<script>
    async function deleteGrantCycle(id) {
        if (confirm('Are you sure you want to delete this grant cycle?')) {
            try {
                const response = await fetch(`/grant-cycles/${id}/delete`, {
                    method: 'POST',
                });
                if (response.ok) {
                    window.location.href = '/grant-cycles';
                } else {
                    alert('Error deleting grant cycle');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting grant cycle');
            }
        }
    }
</script>
{% endblock %} 
