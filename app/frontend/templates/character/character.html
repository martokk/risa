{% extends "base/base.html" %}

{% if character %}
    {% set title = "View/Edit Character: " ~ character.name %}
{% else %}
    {% set title = "Create New Character" %}
{% endif %}

{% block title %}{{ title }}{% endblock %}
{% block content_header %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <form id="characterForm">
                <div class="card card-primary" id="character-form-container">
                    <div class="card-header">
                        <h3 class="card-title">
                            {% if character %}
                                {{ character.name }} ({{ character.id }})
                            {% else %}
                                Character Details
                            {% endif %}
                        </h3>
                        {% if character %}
                        <div class="card-tools">
                            <a href="{{ url_for('list_characters_page') }}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-arrow-left"></i> Back to List
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if character %}
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">ID:</dt>
                            <dd class="col-sm-9 mb-0">{{ character.id }}</dd>
                        </dl>
                        {% endif %}
                        
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Person Name:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="person_name">{{ character.person_name or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0">
                                    <input type="text" class="form-control form-control-sm" id="personName" name="person_name">
                                    <small id="personNamePreview" class="form-text text-muted"></small>
                                </dd>
                            {% endif %}
                        </dl>

                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Character Name 1:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="character_name1">{{ character.character_name1 or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="character_name1"></dd>
                            {% endif %}
                        </dl>
                        
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Character Name 2:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="character_name2">{{ character.character_name2 or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="character_name2"></dd>
                            {% endif %}
                        </dl>
    
                        <dl class="row py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Character Name 3:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="character_name3">{{ character.character_name3 or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="character_name3"></dd>
                            {% endif %}
                        </dl>

                        <h5 class="text-bg-primary rounded px-3 py-1 mt-3">Character Attributes</h5>
                        
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Is Known:</dt>
                            <dd class="col-sm-9 mb-0">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="is_known" {% if character %}data-field="is_known"{% endif %} {% if character and character.is_known %}checked{% endif %}>
                                </div>
                            </dd>
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Age Group:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="age_group">{{ character.age_group or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="age_group"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Race:</dt>
                             {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="race">{{ character.race or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="race"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Skin Color:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="skin_color">{{ character.skin_color or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="skin_color"></dd>
                            {% endif %}
                        </dl>

                        <h5 class="text-bg-primary rounded px-3 py-1 mt-3">Head Attributes</h5>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Hair Color:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="hair_color">{{ character.hair_color or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="hair_color"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Hair Style:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="hair_style">{{ character.hair_style or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="hair_style"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Hair Length:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="hair_length">{{ character.hair_length or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="hair_length"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Face Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="face_type">{{ character.face_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="face_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Eye Color:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="eye_color">{{ character.eye_color or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="eye_color"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Makeup Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="makeup_type">{{ character.makeup_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="makeup_type"></dd>
                            {% endif %}
                        </dl>

                        <h5 class="text-bg-primary rounded px-3 py-1 mt-3">Body Attributes</h5>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Body Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="body_type">{{ character.body_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="body_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Breasts Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="breasts_type">{{ character.breasts_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="breasts_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Breasts Size:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="breasts_size">{{ character.breasts_size or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="breasts_size"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Nipples Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="nipples_type">{{ character.nipples_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="nipples_type"></dd>
                            {% endif %}
                        </dl>

                        <h5 class="text-bg-primary rounded px-3 py-1 mt-3">Other Physical Attributes</h5>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Hands Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="hands_type">{{ character.hands_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="hands_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Hips Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="hips_type">{{ character.hips_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="hips_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Ass Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="ass_type">{{ character.ass_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="ass_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Pussy Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="pussy_type">{{ character.pussy_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="pussy_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Legs Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="legs_type">{{ character.legs_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="legs_type"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Feet Type:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="feet_type">{{ character.feet_type or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="feet_type"></dd>
                            {% endif %}
                        </dl>

                        <h5 class="text-bg-primary rounded px-3 py-1 mt-3">Clothing Attributes</h5>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Clothing - Head:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="clothing_head">{{ character.clothing_head or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="clothing_head"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Clothing - Upper Body:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="clothing_upper_body">{{ character.clothing_upper_body or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="clothing_upper_body"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row border-bottom py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Clothing - Lower Body:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="clothing_lower_body">{{ character.clothing_lower_body or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="clothing_lower_body"></dd>
                            {% endif %}
                        </dl>
                        <dl class="row py-1 align-items-center mb-0">
                            <dt class="col-sm-3">Clothing - Feet:</dt>
                            {% if character %}
                                <dd class="col-sm-9 mb-0" data-editable="true" data-field="clothing_feet">{{ character.clothing_feet or '' }}</dd>
                            {% else %}
                                <dd class="col-sm-9 mb-0"><input type="text" class="form-control form-control-sm" name="clothing_feet"></dd>
                            {% endif %}
                        </dl>
                    </div>
                    {% if not character %}
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">Create Character</button>
                        <a href="{{ url_for('list_characters_page') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
        {% if character %}
        <div class="col-md-4">
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Associated SD Extra Networks</h3>
                    <div class="card-tools">
                         <a href="/sd-extra-network/create?character_id={{ character.id }}" class="btn btn-light btn-sm">
                            <i class="fas fa-plus"></i> Add New
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if character.sd_extra_networks %}
                        <ul class="list-group list-group-flush">
                        {% for en in character.sd_extra_networks %}
                            <li class="list-group-item">
                                <a href="{{ url_for('view_sd_extra_network_page', sd_extra_network_id=en.id) }}">
                                    {{ en.safetensors.name if en.safetensors else en.id }}
                                </a>
                                <br>
                                <small class="text-muted">
                                    Base Model: 
                                    {% if en.sd_base_model_id %}
                                         <a href="{{ url_for('view_sd_base_model_page', sd_base_model_id=en.sd_base_model.id) }}">{{ en.sd_base_model.name if en.sd_base_model.name else en.sd_base_model.id }}</a>
                                    {% endif %}
                                    <br>
                                    {% if en.network_tag %}Tag: {{en.network_tag}}{% endif %}
                                    <br>
                                    {% if en.network_trigger %}Trigger: {{en.network_trigger}}{% endif %}
                                </small>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p class="p-3">No SD Extra Networks associated with this character.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block js_scripts %}
<script type="module">
    import { initializeApi, apiCrud, uiHelpers } from '/static/js/api_utils.js';
    
    {% if tokens and tokens.access_token and tokens.refresh_token %}
    initializeApi({
        access_token: "{{ tokens.access_token }}",
        refresh_token: "{{ tokens.refresh_token }}"
    });
    {% else %}
    console.warn('API tokens not found, API calls may fail.');
    initializeApi({});
    {% endif %}

    {% if character %}
        {# VIEW/EDIT MODE SCRIPT #}
        import { initializeInlineEditor } from '/static/js/components/inline-editor.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeInlineEditor({
                containerSelector: '#character-form-container',
                entityType: 'characters',
                entityId: '{{ character.id }}'
            });
        });

    {% else %}
        {# CREATE MODE SCRIPT #}
        const form = document.getElementById('characterForm');
        if (form) {
            function formatName(name) {
                if (!name) return '';
                name = name.replace(/[_-]+/g, ' ');
                return name.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ').trim();
            }

            const personNameInput = document.getElementById('personName');
            const personNamePreview = document.getElementById('personNamePreview');
            
            if (personNameInput && personNamePreview) {
                personNameInput.addEventListener('input', function(e) {
                    const rawValue = e.target.value;
                    const formattedName = formatName(rawValue);
                    if (formattedName !== rawValue) {
                        personNamePreview.textContent = `Will be saved as: ${formattedName}`;
                    } else {
                        personNamePreview.textContent = '';
                    }
                });

                personNameInput.addEventListener('blur', function(e) {
                    e.target.value = formatName(e.target.value);
                    personNamePreview.textContent = '';
                });
            }

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const formData = uiHelpers.getFormData('characterForm');
                const processedFormData = {};

                try {
                    formData.person_name = formData.person_name ? formatName(formData.person_name) : formData.person_name;
                    formData.character_name1 = formData.character_name1 ? formatName(formData.character_name1) : formData.character_name1;

                    const id_name = formData.person_name || formData.character_name1;
                    if (!id_name) {
                        uiHelpers.showToast('Person Name or Character Name 1 is required to create an ID.', 'error');
                        return;
                    }
                    formData.id = id_name.toLowerCase().replace(/\s+/g, '_');
                    
                    for (const key in formData) {
                        if (formData[key] !== "") {
                            processedFormData[key] = formData[key];
                        }
                    }

                    const response = await apiCrud.create('characters', processedFormData);
                    uiHelpers.showToast('Character created successfully!', 'success');
                    setTimeout(() => {
                        uiHelpers.navigateTo(`/character/${response.id}/view`);
                    }, 1000);
                } catch (error) {
                    console.error('Failed to create Character:', error);
                    let errorMessage = error.message || 'Failed to create Character.';
                    if (error.responseJSON && error.responseJSON.detail.includes('UNIQUE constraint failed')) {
                        errorMessage = `A character with the ID "${processedFormData.id}" already exists.`;
                    }
                    uiHelpers.showToast(errorMessage, 'error');
                }
            });
        }
    {% endif %}
</script>
{% endblock %} 
