{% extends "scripts/modals/_modal_script_base.html" %}

{% block modal_id %}modalGenerateXyForLoraEpochs{% endblock %}
{% block modal_label_id %}modalGenerateXyForLoraEpochsLabel{% endblock %}
{% block modal_title %}Generate XY Plot for Lora Epochs{% endblock %}
{% block script_id %}generate-xy-for-lora-epochs{% endblock %} {# API endpoint #}

{% block modal_input %}
    <div class="mb-3">
        <!-- SD Checkpoint ID and Lora Output Name in a row -->
        <div class="row g-2 mb-2">

            <!-- Lora Output Name -->
            <div class="col">
                <label for="lora_output_name" class="form-label">Lora Output Name</label>
                <select class="form-select" id="lora_output_name" name="lora_output_name">
                    <option value="">Trained Lora</option>
                    {% for trained_lora_safetensors in trained_lora_safetensors %}
                        <option value="{{ trained_lora_safetensors.lora_output_name }}"
                                data-min-epoch="{{ trained_lora_safetensors.min_epoch }}"
                                data-max-epoch="{{ trained_lora_safetensors.max_epoch }}">
                            {{ trained_lora_safetensors.lora_output_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Character -->
            <div class="col">
                <label for="character_id" class="form-label">Character</label>
                <select class="form-select" id="character_id" name="character_id">
                    <option value="">Character</option>
                    {% for character in characters %}
                    <option value="{{ character.id }}">{{ character.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- SD Checkpoint ID -->
            <div class="col">
                <label for="sd_checkpoint_id" class="form-label">SD Checkpoint ID</label>
                <select class="form-select" id="sd_checkpoint_id" name="sd_checkpoint_id">
                    <option value="">Checkpoint</option>
                    {% for sd_checkpoint in sd_checkpoints %}
                    <option value="{{ sd_checkpoint.id }}">{{ sd_checkpoint.name }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>
        <!-- Epochs and Seeds in a row -->
        <div class="row g-2 mb-2">
            <div class="col">
                <label for="start_epoch" class="form-label">Start Epoch</label>
                <input type="number" class="form-control" id="start_epoch" name="start_epoch" value="9" required>
            </div>
            <div class="col">
                <label for="end_epoch" class="form-label">End Epoch</label>
                <input type="number" class="form-control" id="end_epoch" name="end_epoch" value="30" required>
            </div>
            <div class="col">
                <label for="max_epochs" class="form-label">Max Epochs</label>
                <input type="number" class="form-control" id="max_epochs" name="max_epochs" value="30" required>
            </div>
            <div class="col">
                <label for="seeds_per_epoch" class="form-label">Seeds/Epoch</label>
                <input type="number" class="form-control" id="seeds_per_epoch" name="seeds_per_epoch" value="1" required>
            </div>
            
        </div>

        <!-- Accordion for Settings -->
        <div class="accordion mb-3" id="settingsAccordion">
            <!-- Text2Img Settings Accordion Item -->
            <div class="accordion-item">

                <!-- Text2Img Settings Accordion Header -->
                <h2 class="accordion-header" id="headingText2Img">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseText2Img" aria-expanded="true" aria-controls="collapseText2Img">
                        Text2Img Settings
                    </button>
                </h2>

                <!-- Text2Img Settings Accordion Body -->
                <div id="collapseText2Img" class="accordion-collapse collapse show" aria-labelledby="headingText2Img" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="row g-2 mb-2">

                            <!-- Sampler Name -->
                            <div class="col">
                                <label for="sampler_name" class="form-label">Sampler Name</label>
                                <input type="text" class="form-control" id="sampler_name" name="sampler_name" value="Euler a">
                            </div>

                            <!-- Seed --> 
                            <div class="col">
                                <label for="seed" class="form-label">Seed</label>
                                <input type="number" class="form-control" id="seed" name="seed" value="-1">
                            </div>

                            <!-- Steps -->
                            <div class="col">
                                <label for="steps" class="form-label">Steps</label>
                                <input type="number" class="form-control" id="steps" name="steps" value="20">
                            </div>

                            <!-- CFG Scale -->
                            <div class="col">
                                <label for="cfg_scale" class="form-label">CFG Scale</label>
                                <input type="number" step="0.1" class="form-control" id="cfg_scale" name="cfg_scale" value="7.0">
                            </div>

                        </div>

                        <div class="row g-2 mb-2">

                            <!-- Width -->
                            <div class="col">
                                <label for="width" class="form-label">Width</label>
                                <input type="number" class="form-control" id="width" name="width" value="768">
                            </div>

                            <!-- Height -->
                            <div class="col">
                                <label for="height" class="form-label">Height</label>
                                <input type="number" class="form-control" id="height" name="height" value="768">
                            </div>

                            <!-- Batch Size -->
                            <div class="col">
                                <label for="batch_size" class="form-label">Batch Size</label>
                                <input type="number" class="form-control" id="batch_size" name="batch_size" value="1">
                            </div>

                            <!-- N Inter -->
                            <div class="col">
                                <label for="n_iter" class="form-label">N Iter</label>
                                <input type="number" class="form-control" id="n_iter" name="n_iter" value="1">
                            </div>

                        </div>

                        <!-- Styles -->
                        <div class="mb-2">
                            <label for="styles" class="form-label">Styles (comma separated)</label>
                            <input type="text" class="form-control" id="styles" name="styles" value="general">
                        </div>

                        <!-- Prompt -->
                        <div class="mb-2">
                            <label for="prompt" class="form-label">Prompt</label>
                            <textarea class="form-control" id="prompt" name="prompt" rows="2" value="<lora:XXX:1> trigger, 1girl, smile, portrait"></textarea>
                        </div>

                        <!-- Negative Prompt -->
                        <div class="mb-2">
                            <label for="negative_prompt" class="form-label">Negative Prompt</label>
                            <textarea class="form-control" id="negative_prompt" name="negative_prompt" rows="2" value=""></textarea>
                        </div>
        
                    </div>
                </div>
            </div>

            
        </div>

    </div>

    <button type="submit" class="btn btn-primary float-end">Add to Job Queue</button>
{% endblock %}


{% block modal_output %}
        <!-- Output/result will be rendered here by JS -->
{% endblock %}


{% block modal_footer %}
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
{% endblock %}


{% block modal_scripts %}
    {{ super() }}
    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const loraSelect = document.getElementById('lora_output_name');
            const characterSelect = document.getElementById('character_id');
            const checkpointSelect = document.getElementById('sd_checkpoint_id');
            const startEpochInput = document.getElementById('start_epoch');
            const endEpochInput = document.getElementById('end_epoch');
            const maxEpochsInput = document.getElementById('max_epochs');
            const promptInput = document.getElementById('prompt');

            if (!loraSelect || !characterSelect || !checkpointSelect) return;

            // Collect all character and checkpoint IDs from the options (skip empty value)
            const characterIds = Array.from(characterSelect.options)
                .map(opt => opt.value)
                .filter(val => val);
            const checkpointIds = Array.from(checkpointSelect.options)
                .map(opt => opt.value)
                .filter(val => val);

            loraSelect.addEventListener('change', () => {
                const selectedOption = loraSelect.options[loraSelect.selectedIndex];
                const minEpoch = selectedOption.getAttribute('data-min-epoch');
                const maxEpochs = selectedOption.getAttribute('data-max-epoch');
                if (minEpoch && maxEpochs && startEpochInput && endEpochInput) {
                    startEpochInput.value = minEpoch;
                    endEpochInput.value = maxEpochs;
                    maxEpochsInput.value = maxEpochs;
                }
                // Character selection
                let foundChar = false;
                for (const charId of characterIds) {
                    if (loraSelect.value.toLowerCase().includes(charId.toLowerCase())) {
                        characterSelect.value = charId;
                        foundChar = true;
                        break;
                    }
                }
                if (!foundChar) characterSelect.value = '';

                // Checkpoint selection
                let foundCkpt = false;
                for (const ckptId of checkpointIds) {
                    if (loraSelect.value.toLowerCase().includes(ckptId.toLowerCase())) {
                        checkpointSelect.value = ckptId;
                        foundCkpt = true;
                        break;
                    }
                }

                // Prompt
                promptInput.value = `<lora:${loraSelect.value}-${startEpochInput.value.padStart(6, '0')}:1> trigger, 1girl, smile, portrait`;
            
                if (!foundCkpt) checkpointSelect.value = '';
            });
        });
    </script>
{% endblock %} 
