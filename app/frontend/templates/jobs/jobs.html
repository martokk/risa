{% extends "base/sidebar_right.html" %}

{% block title %}Job Queue{% endblock %}

{% block sidebar_right %}
    {% include "/jobs/_quick_jobs.html" %}
{% endblock sidebar_right %}


{% macro job_row(job) %}
<tr id="job-row-{{ job.id }}" onclick="openEditModal('{{ job.id }}')" style="cursor: pointer;">
    <td>{{ job.name }}</td>
    <td><small>{{ job.id|string|truncate(8, True, '') }}</small></td>
    <td>{{ job.recurrence | default('None', True) | title }}</td>
    <td>{{ job.type.value | title }}</td>
    <td><small>{{ job.command|truncate(50, True, '...') }}</small></td>
    <td class="text-center">
        <span class="badge 
            {% if job.priority == 'high' %}bg-danger
            {% elif job.priority == 'medium' %}bg-warning text-dark
            {% else %}bg-secondary
            {% endif %}">
            {{ job.priority.value | title }}
        </span>
    </td>
    <td class="text-center">
        <span class="badge
            {% if job.status == 'running' %}bg-primary
            {% elif job.status == 'queued' %}bg-info text-dark
            {% elif job.status == 'done' %}bg-success
            {% elif job.status == 'failed' %}bg-danger
            {% else %}bg-secondary
            {% endif %}">
            {{ job.status.value | title }}
        </span>
    </td>
    <td class="text-end">
        <div class="btn-group" role="group">

            {% if job.status == 'pending' %}
                <button class="btn btn-sm btn-outline-primary" title="Start Job" onclick="queueJob(event, '{{ job.id }}')"><i class="fas fa-play"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '{{ job.id }}')"><i class="fas fa-trash"></i></button>

            {% elif job.status == 'queued' %}
                <button class="btn btn-sm btn-outline-warning" title="Unqueue Job" onclick="unqueueJob(event, '{{ job.id }}')"><i class="fas fa-clock"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '{{ job.id }}')"><i class="fas fa-trash"></i></button>

            {% elif job.status == 'running' %}
                <button class="btn btn-sm btn-outline-warning" title="Stop Job" onclick="stopJob(event, '{{ job.id }}')"><i class="fas fa-stop"></i></button>
                <button class="btn btn-sm btn-outline-info" title="View Log" onclick="viewLog(event, '{{ job.id }}')"><i
                        class="fas fa-file-alt"></i></button>
        
            {% elif job.status == 'failed' %}
                <button class="btn btn-sm btn-outline-success" title="Retry Job" onclick="queueJob(event, '{{ job.id }}')"><i class="fas fa-sync-alt"></i></button>
                <button class="btn btn-sm btn-outline-info" title="View Log" onclick="viewLog(event, '{{ job.id }}')"><i class="fas fa-file-alt"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '{{ job.id }}')"><i class="fas fa-trash"></i></button
                >
            {% elif job.status == 'done' %}
                <button class="btn btn-sm btn-outline-info" title="View Log" onclick="viewLog(event, '{{ job.id }}')"><i class="fas fa-file-alt"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '{{ job.id }}')"><i class="fas fa-trash"></i></button>
                
            {% endif %}
        </div>
    </td>
</tr>
{% endmacro %}

{% block content %}
<div class="">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Jobs ({{ ENV_NAME }})</h3>

        <div class="d-flex align-items-center">
            <span id="consumerStatusBadge" class="ms-2 me-2"></span>
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-outline-secondary" id="startConsumerBtn" title="Start Huey Consumer">
                    <i class="fas fa-play"></i>                 </button>
                <button type="button" class="btn btn-outline-secondary" id="stopConsumerBtn" title="Stop Huey Consumer">
                    <i class="fas fa-stop"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="viewLogBtn" title="View Log">
                    <i class="fas fa-file-alt"></i>
                </button>
            </div>
        </div>

        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-primary ms-5" data-bs-toggle="modal" data-bs-target="#jobModal">
                <i class="fas fa-plus"></i> Add Job
            </button>
        </div>
    </div>

    <!-- Active Queue -->
    <div class="card">
        <div class="card-header">
            <h5>Queue</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>ID</th>
                        <th>Recurrence</th>
                        <th>Type</th>
                        <th>Command</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% set ns = namespace(has_active_jobs=false) %}
                    {% for job in jobs %}
                        {% if job.status == 'queued' or job.status == 'running' or job.status == 'pending' %}
                            {{ job_row(job) }}
                            {% set ns.has_active_jobs = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not ns.has_active_jobs %}
                        <tr>
                            <td colspan="8" class="text-center">No pending, running, or queued jobs.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- History -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>History</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>ID</th>
                        <th>Recurrence</th>
                        <th>Type</th>
                        <th>Command</th>
                        <th class="text-center">Priority</th>
                        <th class="text-center">Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% set ns = namespace(has_history_jobs=false) %}
                    {% for job in jobs | sort(attribute='created_at', reverse=True) %}
                        {% if job.status == 'done' or job.status == 'failed' %}
                            {{ job_row(job) }}
                            {% set ns.has_history_jobs = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not ns.has_history_jobs %}
                    <tr>
                        <td colspan="8" class="text-center">No jobs in history.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Job Modal -->
<div class="modal fade" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobModalLabel">Add New Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="jobForm">
                    <input type="hidden" id="jobId" name="id">
                    <input type="hidden" id="jobEnvName" name="env_name" value="{{ ENV_NAME }}">

                    <div class="mb-3">
                        <label for="jobName" class="form-label">Job Name</label>
                        <input type="text" class="form-control" id="jobName" name="name">
                    </div>
                    <div class="mb-3">
                        <label for="jobType" class="form-label">Job Type</label>
                        <select class="form-select" id="jobType" name="type" required>
                            <option value="command">Command</option>
                            <option value="api_post">API Post</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="jobCommand" class="form-label">Command or URL</label>
                        <textarea class="form-control" id="jobCommand" name="command" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="jobPriority" class="form-label">Priority</label>
                        <select class="form-select" id="jobPriority" name="priority" required>
                            <option value="highest">Highest</option>
                            <option value="high">High</option>
                            <option value="normal" selected>Normal</option>
                            <option value="low">Low</option>
                            <option value="lowest">Lowest</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="jobRecurrence" class="form-label">Recurrence</label>
                        <select class="form-select" id="jobRecurrence" name="recurrence">
                            <option value="">None</option>
                            <option value="hourly">Hourly</option>
                            <option value="daily">Daily</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="jobMeta" class="form-label">Meta (JSON for API Post)</label>
                        <textarea class="form-control" id="jobMeta" name="meta" rows="3">{}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveJobBtn">Save Job</button>
            </div>
        </div>
    </div>
</div>

<!-- Log Viewer Modal -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalLabel">Job Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body position-relative">
                <pre id="logContent" class="bg-dark small" style="word-wrap: break-word; max-height: 70vh; overflow-y: auto;font-size: x-small;"></pre>
                <button id="scrollToBottomBtn" class="btn btn-sm btn-primary position-absolute end-0 bottom-0 m-3" style="display:none; z-index:10;">
                    Scroll to Latest
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this job? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js_scripts %}
<script type="module">
    import { apiCrud, uiHelpers } from '/static/js/api_utils.js';
    import { toast } from '/static/js/toast.js';
    import { LogStreamer } from '/static/js/tools/log_streamer.js';

    const jobModalEl = document.getElementById('jobModal');
    const jobModal = new bootstrap.Modal(jobModalEl);
    const jobForm = document.getElementById('jobForm');
    const jobModalLabel = document.getElementById('jobModalLabel');
    const saveJobBtn = document.getElementById('saveJobBtn');

    let logSocket = null;
    let logStreamer = null;

    function resetForm() {
        jobForm.reset();
        document.getElementById('jobId').value = '';
        jobModalLabel.textContent = 'Add New Job';
    }

    // Reset form when modal is hidden
    jobModalEl.addEventListener('hidden.bs.modal', resetForm);

    // Handle "Add Job" button click
    document.querySelector('button[data-bs-target="#jobModal"]').addEventListener('click', () => {
        resetForm();
    });

    saveJobBtn.addEventListener('click', async () => {
        try {
            const formData = new FormData(jobForm);
            const data = Object.fromEntries(formData.entries());
            const jobId = data.id;
            
            // Do not send the id in the body for updates
            delete data.id;

            // Handle meta and recurrence
            data.meta = data.meta ? JSON.parse(data.meta) : {};
            if (data.recurrence === "") {
                delete data.recurrence;
            }

            if (jobId) {
                // Update existing job
                await apiCrud.update('jobs', jobId, data);
                toast.show('Job updated successfully!', 'success');
            } else {
                // Create new job
                await apiCrud.create('jobs', data);
                toast.show('Job added successfully!', 'success');
            }
            
            jobModal.hide();
            // setTimeout(() => uiHelpers.refreshPage(), 500);
        } catch (error) {
            toast.show(error.message || 'An unknown error occurred', 'danger');
        }
    });

    window.openEditModal = async function(jobId) {
        resetForm();
        try {
            const job = await apiCrud.getById('jobs', jobId);
            jobModalLabel.textContent = 'Edit Job';
            
            // Populate form
            document.getElementById('jobId').value = job.id;
            document.getElementById('jobName').value = job.name;
            document.getElementById('jobType').value = job.type;
            document.getElementById('jobCommand').value = job.command;
            document.getElementById('jobPriority').value = job.priority;
            document.getElementById('jobRecurrence').value = job.recurrence || '';
            document.getElementById('jobMeta').value = JSON.stringify(job.meta || {}, null, 2);

            jobModal.show();
        } catch (error) {
            toast.show(error.message || `Failed to fetch job ${jobId}`, 'danger');
        }
    };

    window.viewLog = function(event, jobId) {
        event.stopPropagation();
        if (logStreamer) {
            logStreamer.viewLog(jobId, 'job');
        } else {
            console.error("Log streamer is not initialized.");
        }
    };

    window.queueJob = async function(event, jobId) {
        // Stop event propagation to prevent the row's onclick from firing
        event.stopPropagation();
        try {
            await apiCrud.putText(`jobs/${jobId}/status`, {"status": "queued"});
            toast.show('Job queued.', 'success');
            //csetTimeout(() => uiHelpers.refreshPage(), 1000);
        } catch (error) {
            toast.show(error.message || 'Failed to queue job', 'danger');
        }
    };

    window.unqueueJob = async function (event, jobId) {
            // Stop event propagation to prevent the row's onclick from firing
            event.stopPropagation();
            try {
                await apiCrud.putText(`jobs/${jobId}/status`, { "status": "pending" });
                toast.show('Job unqueued.', 'success');
                //csetTimeout(() => uiHelpers.refreshPage(), 1000);
            } catch (error) {
                toast.show(error.message || 'Failed to unqueue job', 'danger');
            }
        };

    window.deleteJob = function(event, jobId) {
        // Stop event propagation to prevent the row's onclick from firing
        event.stopPropagation();
        // Show the confirmation modal
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        // Use a one-time event listener to handle the confirmation
        confirmBtn.onclick = async () => {
            try {
                await apiCrud.delete('jobs', jobId);
                toast.show('Job deleted successfully.', 'success');
                const row = document.getElementById(`job-row-${jobId}`);
                if (row) row.remove();
            } catch (error) {
                toast.show(error.message || 'Failed to delete job', 'danger');
            } finally {
                deleteModal.hide();
            }
        };

        deleteModal.show();
    };


    window.stopJob = async function (event, jobId) {
        event.stopPropagation();
        try {
            const resp = await apiCrud.postText(`jobs/${jobId}/kill`, {});
            toast.show('Job stopped.', 'success');
            // Optionally refresh the UI
            // setTimeout(() => uiHelpers.refreshPage(), 1000);
        } catch (error) {
            toast.show(error.message || 'Failed to stop job', 'danger');
        }
    };

    // --- WebSocket Job Queue Updates ---
    function renderJobRow(job) {
        // Returns a string of HTML for a job row, matching the macro in the template
        const priorityBadge = job.priority === 'high' ? 'bg-danger'
            : job.priority === 'medium' ? 'bg-warning text-dark'
            : 'bg-secondary';
        const statusBadge = job.status === 'running' ? 'bg-primary'
            : job.status === 'queued' ? 'bg-info text-dark'
            : job.status === 'done' ? 'bg-success'
            : job.status === 'failed' ? 'bg-danger'
            : 'bg-secondary';
        let actions = '';
        if (job.status === 'pending') {
            actions = `
                <button class="btn btn-sm btn-outline-primary" title="Start Job" onclick="queueJob(event, '${job.id}')"><i class="fas fa-plus"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '${job.id}')"><i class="fas fa-trash"></i></button>
            `;
        } else if (job.status === 'queued') {
            actions = `
                <button class="btn btn-sm btn-outline-warning" title="Unqueue Job" onclick="unqueueJob(event, '${job.id}')"><i class="fas fa-clock"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '${job.id}')"><i class="fas fa-trash"></i></button>
            `;
        } else if (job.status === 'running') {
            actions = `
                <button class="btn btn-sm btn-outline-warning" title="Stop Job" onclick="stopJob(event, '${job.id}')"><i class="fas fa-stop"></i></button>
                <button class="btn btn-sm btn-outline-info" title="View Log" onclick="viewLog(event, '${job.id}')"><i class="fas fa-file-alt"></i></button>
            `;
        } else if (job.status === 'failed') {
            actions = `
                <button class="btn btn-sm btn-outline-success" title="Retry Job" onclick="queueJob(event, '${job.id}')"><i class="fas fa-sync-alt"></i></button>
                <button class="btn btn-sm btn-outline-info" title="View Log" onclick="viewLog(event, '${job.id}')"><i class="fas fa-file-alt"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '${job.id}')"><i class="fas fa-trash"></i></button>
            `;
        } else if (job.status === 'done') {
            actions = `
                <button class="btn btn-sm btn-outline-success" title="Retry Job" onclick="queueJob(event, '${job.id}')"><i class="fas fa-sync-alt"></i></button>
                <button class="btn btn-sm btn-outline-info" title="View Log" onclick="viewLog(event, '${job.id}')"><i class="fas fa-file-alt"></i></button>
                <button class="btn btn-sm btn-outline-danger" title="Delete Job" onclick="deleteJob(event, '${job.id}')"><i class="fas fa-trash"></i></button>
            `;
        }
        return `
<tr id="job-row-${job.id}" onclick="openEditModal('${job.id}')" style="cursor: pointer;">
    <td>${job.name}</td>
    <td><small>${String(job.id).substring(0, 8)}</small></td>
    <td>${job.recurrence ? job.recurrence.charAt(0).toUpperCase() + job.recurrence.slice(1) : 'None'}</td>
    <td>${job.type.charAt(0).toUpperCase() + job.type.slice(1)}</td>
    <td><small>${job.command.length > 50 ? job.command.substring(0, 50) + '...' : job.command}</small></td>
    <td class="text-center"><span class="badge ${priorityBadge}">${job.priority.charAt(0).toUpperCase() + job.priority.slice(1)}</span></td>
    <td class="text-center"><span class="badge ${statusBadge}">${job.status.charAt(0).toUpperCase() + job.status.slice(1)}</span></td>
    <td class="text-end"><div class="btn-group" role="group">${actions}</div></td>
</tr>`;
    }

    function updateJobTables(jobs) {
        console.log("updateJobTables called with jobs:", jobs);
        // Sort jobs for active and history tables
        const statusOrder = { running: 0, queued: 1, pending: 2, failed: 3, done: 4 };
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        jobs.sort((a, b) => (statusOrder[a.status] - statusOrder[b.status]) || (priorityOrder[a.priority] - priorityOrder[b.priority]));

        // Active jobs
        const activeJobs = jobs.filter(j => ['queued', 'running', 'pending'].includes(j.status));
        const activeTbody = document.querySelector('.card .card-body table tbody');
        console.log('Active jobs:', activeJobs);
        console.log('Active tbody:', activeTbody);
        activeTbody.innerHTML = activeJobs.length
            ? activeJobs.map(renderJobRow).join('')
            : '<tr><td colspan="8" class="text-center">No active jobs in the queue.</td></tr>';

        // History jobs (sorted by created_at descending)
        const historyJobs = jobs.filter(j => ['done', 'failed'].includes(j.status)).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        const historyTbody = document.querySelector('.card.mt-4 .card-body table tbody');
        console.log('History jobs:', historyJobs);
        console.log('History tbody:', historyTbody);
        historyTbody.innerHTML = historyJobs.length
            ? historyJobs.map(renderJobRow).join('')
            : '<tr><td colspan="8" class="text-center">No jobs in history.</td></tr>';
    }

    function updateConsumerStatusBadge(status) {
        const badge = document.getElementById('consumerStatusBadge');
        const startBtn = document.getElementById('startConsumerBtn');
        const stopBtn = document.getElementById('stopConsumerBtn');
        if (!badge) return;
        if (status === 'running') {
            badge.innerHTML = '<span class="badge bg-success">Consumer<br>Running</span>';
            startBtn.classList = "btn btn-outline-secondary";
            stopBtn.classList = "btn btn-danger";
        } else if (status === 'stopped') {
            badge.innerHTML = '<span class="badge bg-secondary">Consumer<br>Stopped</span>';
            startBtn.classList = "btn btn-success";
            stopBtn.classList = "btn btn-outline-secondary";
        } else {
            badge.innerHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-question"></i><br> Unknown</span>';
            startBtn.classList = "btn btn-outline-warning";
            stopBtn.classList = "btn btn-outline-warning";
        }
    }

    function connectJobQueueWebSocket() {
        let protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        let wsUrl = `${protocol}://${window.location.host}/api/v1/ws/job-queue`;
        logSocket = new WebSocket(wsUrl);

        // Initialize the LogStreamer once the socket is created
        logStreamer = new LogStreamer('logModal', 'logContent', 'scrollToBottomBtn', logSocket);

        logSocket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                // The log streamer now handles its own messages.
                // We only need to handle non-log messages here.
                if (data.jobs) {
                    updateJobTables(data.jobs);
                }
                if (data.consumer_status) {
                    updateConsumerStatusBadge(data.consumer_status);
                }
            } catch (e) {
                console.error('Failed to parse WebSocket message:', e);
            }
        };
        logSocket.onclose = function() {
            updateConsumerStatusBadge('unknown');
            setTimeout(connectJobQueueWebSocket, 3000);
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        connectJobQueueWebSocket();

        // Start/Stop Huey Consumer buttons
        const startBtn = document.getElementById('startConsumerBtn');
        const stopBtn = document.getElementById('stopConsumerBtn');
        const viewLogBtn = document.getElementById('viewLogBtn');

        if (viewLogBtn && logStreamer) {
            viewLogBtn.addEventListener('click', () => {
                logStreamer.viewLog('consumer', 'consumer');
            });
        }

        if (startBtn) {
            startBtn.addEventListener('click', async () => {
                try {
                    const resp = await fetch('/api/v1/jobs/start-consumer', { method: 'POST' });
                    const data = await resp.json();
                    toast.show(data.message, data.success ? 'success' : 'danger');
                } catch (err) {
                    toast.show('Failed to start consumer', 'danger');
                }
            });
        }
        if (stopBtn) {
            stopBtn.addEventListener('click', async () => {
                try {
                    const resp = await fetch('/api/v1/jobs/stop-consumer', { method: 'POST' });
                    const data = await resp.json();
                    toast.show(data.message, data.success ? 'success' : 'danger');
                } catch (err) {
                    toast.show('Failed to stop consumer', 'danger');
                }
            });
        }
    });
</script>
{% endblock %} 
