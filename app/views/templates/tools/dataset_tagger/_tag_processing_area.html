{# HTMX Tag Processing Area Partial - Topbar Redesign with Header #}
<div class="topbar-tag-processor sticky-top py-2 px-3 bg-body-tertiary border-bottom shadow-sm">
    {# Form becomes a flex column to stack header and main content row #}
    <form hx-post="{{ url_for('post_dataset_tagger_process_tag') }}" hx-target="#tag-processor" hx-swap="innerHTML" class="d-flex flex-column">

        {# Hidden fields for TaggingWorkflowState - Values from initial_state context #}
        <input type="hidden" name="character_id" value="{{ initial_state.character_id }}">
        <input type="hidden" name="folder_path" value="{{ initial_state.folder_path }}">
        <input type="hidden" name="current_step_index" value="{{ initial_state.current_step_index }}">
        <input type="hidden" name="current_input_type_index_in_step" value="{{ initial_state.current_input_type_index_in_step }}">
        <input type="hidden" name="current_item_index_within_input_type" value="{{ initial_state.current_item_index_within_input_type }}">
        <input type="hidden" name="pending_tags_from_last_manual_input" value="{{ initial_state.pending_tags_from_last_manual_input | join(',') }}">
        <input type="hidden" name="active_manual_input_key" value="{{ initial_state.active_manual_input_key | default('') }}">
        <input type="hidden" name="selected_images_input" id="selectedImagesInput" value="{{ selected_images | join(',') if selected_images else '' }}">

        {# Header for Step Information #}
        {% if initial_step_name %}
            <div class="topbar-step-header w-100 mb-0 pb-0 text-center">
                <small class="fw-bold">Step: {{ initial_step_name }}</small>
                {% if initial_step_description %}
                    <small class="text-muted fst-italic ms-1">- {{ initial_step_description }}</small>
                {% endif %}
            </div>
        {% endif %}

        {# Main Content Row - this div will contain all other elements in a row #}
        <div class="d-flex flex-wrap align-items-center w-75 align-self-center">
            {# Notification Message #}
            {% if notification_message %}
                <div class="alert alert-{{ notification_type | default('info') }} alert-dismissible fade show p-1 px-2 me-2 mb-0 d-inline-flex align-items-center" role="alert" style="font-size: 0.8rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <span class="flex-grow-1" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ notification_message }}</span>
                    <button type="button" class="btn-close btn-sm p-0 ms-2" data-bs-dismiss="alert" aria-label="Close" style="font-size: 0.65rem; line-height: 1; padding: 0.2rem 0.4rem !important;"></button>
                </div>
            {% endif %}
            
            {# Display the initial item (tag or manual question prompt) #}
            <div class="me-2 mb-md-0 mb-1 d-flex align-items-center flex-grow-1" style="min-width: 600px;">
                {% if initial_item_type == "manual_question" %}
                    <label for="manual_tag_input" class="form-label fw-bold small mb-0 me-1">Q:</label>
                    <span class="text-primary small me-2" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;" title="{{ initial_display_item }}">{{ initial_display_item }}</span>
                    <input type="text" class="form-control form-control-sm flex-grow-1" id="manual_tag_input" name="manual_tag_input" placeholder="Tags...">
                {% elif initial_item_type == "tag" %}
                    <div class="d-flex align-items-center justify-content-center w-100">
                        <span class="fw-bold fs-6 me-1">Tag:</span> <span class="badge bg-success fs-6 me-2">{{ initial_display_item }}</span>
                    </div>
                {% elif initial_item_type == "complete" %}
                    <span class="badge bg-success me-2">{{ initial_display_item }}</span>
                {% elif initial_item_type == "info" %}
                    <span class="badge bg-info me-2">{{ initial_display_item }}</span>
                {% elif initial_item_type == "step_description" %}
                    <span class="text-muted small fst-italic me-2">{{ initial_display_item }}</span>
                {% else %}
                    <span class="text-muted small me-2">{{ initial_display_item | default("Loading...") }}</span>
                {% endif %}
            </div>

            {# Action buttons #}
            {% if initial_item_type != 'complete' %}
                <div class="d-flex align-items-center ms-auto">
                    {% if initial_item_type == "manual_question" %}
                        <button type="submit" name="action" value="submit_manual_input" class="btn btn-success btn-sm me-1">Submit</button>
                        <button type="submit" name="action" value="skip_tag" class="btn btn-secondary btn-sm me-1">Skip</button>
                        <button type="button" class="btn btn-outline-info btn-sm me-1" id="selectAllImagesBtn"><i class="fas fa-check-double"></i>All</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllImagesBtn"><i class="fas fa-times-circle"></i>None</button>
                    {% elif initial_item_type == "tag" %}
                        <button type="submit" name="action" value="add_tag" class="btn btn-success btn-sm me-1"><i class="fas fa-plus-circle me-1"></i>Add ({{ selected_images|length if selected_images else 0 }})</button>
                        <button type="submit" name="action" value="skip_tag" class="btn btn-warning btn-sm me-1"><i class="fas fa-forward me-1"></i>Skip</button>
                        <button type="button" class="btn btn-outline-info btn-sm me-1" id="selectAllImagesBtn"><i class="fas fa-check-double"></i>All</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllImagesBtn"><i class="fas fa-times-circle"></i>None</button>
                    {% endif %}
                </div>
            {% endif %}
        </div> {# End Main Content Row #}
    </form>

    {# Phase/Status Message - outside form, below topbar visually if needed, or integrated #}
    {# For a true topbar, this might be omitted or placed elsewhere in the main page #}
    {# {% if initial_item_type != 'complete' %}
        <div class="mt-1 text-muted small" style="font-size: 0.75rem;">
            Phase 5: Image selection and "Select All" now functional. Test thoroughly!
        </div>
    {% else %}
        <div class="mt-1 text-muted small" style="font-size: 0.75rem;">
            Tagging complete. Start a new session if needed.
        </div>
    {% endif %} #}
</div>
